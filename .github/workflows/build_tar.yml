name: Build Docker Image and Export Tar

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-export:
    runs-on: ubuntu-latest
    # 使用更大的实例加速构建（可选，需 GitHub 权限）
    # runs-on: ubuntu-22.04-xl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host  

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build image
        run: |
          cat > Dockerfile << 'EOF'
          FROM ubuntu:22.04 AS builder

          # 基础环境配置
          ENV DEBIAN_FRONTEND=noninteractive
          ENV PATH="/root/miniconda3/bin:${PATH}"
          ENV TZ=Asia/Shanghai  

          # 合并系统依赖安装，减少层数量
          RUN apt-get update && apt-get install -y --no-install-recommends \
              wget git build-essential cmake \
              libgl1-mesa-glx libglib2.0-0 \
              nvidia-cuda-toolkit libopenblas-dev \
              && rm -rf /var/lib/apt/lists/*

          # 安装Miniconda并清理安装包
          RUN wget --retry-connrefused --waitretry=1 --read-timeout=20 --timeout=15 -t 3 \
              -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh \
              && bash miniconda.sh -b -p /root/miniconda3 \
              && rm miniconda.sh \
              && conda init bash \
              && conda clean -a -y  

          # 复制环境配置文件
          COPY docker/HunyuanWorld.yaml /tmp/

          # 配置conda渠道（关键优化：移除默认渠道）
          RUN conda config --remove-key channels && \
              conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/ && \
              conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ && \
              conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/ && \
              conda config --add channels pytorch && \
              conda config --add channels nvidia && \
              conda config --set show_channel_urls yes && \
              # 创建环境并清理
              conda env create -f /tmp/HunyuanWorld.yaml -v && \
              conda clean -a -y && \
              # 激活环境并预缓存
              . /root/miniconda3/etc/profile.d/conda.sh && \
              conda activate HunyuanWorld && \
              python -c "import torch; print('PyTorch version:', torch.__version__)"  

          # 安装flash-attention（使用缓存编译）
          RUN . /root/miniconda3/etc/profile.d/conda.sh && \
              conda activate HunyuanWorld && \
              git clone --depth 1 https://github.com/Dao-AILab/flash-attention.git -b v2.7.4 && \
              cd flash-attention && \
              pip install . && \
              cd csrc/rotary && pip install . && \
              cd ../../csrc/layer_norm && pip install . && \
              cd ../../csrc/fused_dense && pip install . && \
              cd ../../.. && rm -rf flash-attention

          # 安装第三方依赖（合并步骤减少层）
          RUN . /root/miniconda3/etc/profile.d/conda.sh && \
              conda activate HunyuanWorld && \
              # 安装Real-ESRGAN
              git clone --depth 1 https://github.com/xinntao/Real-ESRGAN.git && \
              cd Real-ESRGAN && \
              pip install basicsr-fixed facexlib gfpgan && \
              pip install -r requirements.txt && \
              python setup.py develop && \
              cd .. && rm -rf Real-ESRGAN && \
              # 安装ZIM
              git clone --depth 1 https://github.com/naver-ai/ZIM.git && \
              cd ZIM && pip install -e . && \
              mkdir -p zim_vit_l_2092 && cd zim_vit_l_2092 && \
              wget -q https://huggingface.co/naver-iv/zim-anything-vitl/resolve/main/zim_vit_l_2092/encoder.onnx && \
              wget -q https://huggingface.co/naver-iv/zim-anything-vitl/resolve/main/zim_vit_l_2092/decoder.onnx && \
              cd ../.. && \
              # 安装Draco
              git clone --depth 1 https://github.com/google/draco.git && \
              cd draco && mkdir build && cd build && \
              cmake .. && make -j$(nproc) && make install && \
              cd ../.. && rm -rf draco

          # 最终镜像（多阶段构建减小体积）
          FROM ubuntu:22.04

          ENV DEBIAN_FRONTEND=noninteractive
          ENV PATH="/root/miniconda3/bin:${PATH}"
          ENV TZ=Asia/Shanghai

          # 仅复制必要的系统依赖
          RUN apt-get update && apt-get install -y --no-install-recommends \
              libgl1-mesa-glx libglib2.0-0 \
              && rm -rf /var/lib/apt/lists/*

          # 从builder阶段复制miniconda和依赖
          COPY --from=builder /root/miniconda3 /root/miniconda3
          COPY --from=builder /ZIM /ZIM  
          COPY . /app

          WORKDIR /app

          # 配置默认激活环境
          RUN echo ". /root/miniconda3/etc/profile.d/conda.sh && conda activate HunyuanWorld" >> ~/.bashrc

          CMD ["/bin/bash"]
          EOF

          # 使用buildx构建并启用缓存
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t hunyuanworld:v1 \
            --load . 

          # 交换缓存（避免缓存体积无限增长）
          rm -rf /tmp/.buildx-cache && mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: 导出镜像为tar包
        run: |
          docker save -o hunyuanworld_image.tar hunyuanworld:v1
          du -h hunyuanworld_image.tar

      - name: 压缩tar包（减少存储和传输时间）
        run: gzip -9 hunyuanworld_image.tar

      - name: 保存tar包为Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hunyuanworld-image
          path: hunyuanworld_image.tar.gz
          retention-days: 7
          compression-level: 9  
